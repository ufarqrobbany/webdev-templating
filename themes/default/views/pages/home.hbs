{{#if user}}
  {{!-- Form Buat Post --}}
  <div class="card" style="margin-bottom: 20px;">
    <form action="/api/v1/posts" method="POST" enctype="multipart/form-data" class="create-post-form">
      <div style="display: flex; gap: 10px; margin-bottom: 12px;">
        {{!-- User Avatar --}}
        <div style="width: 40px; height: 40px; background-color: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0;">
          {{slice user.firstName 0 1}}{{slice user.lastName 0 1}}
        </div>
        {{!-- Text Area --}}
        <div style="flex-grow: 1;">
          <textarea name="content" class="form-control" rows="3" placeholder="Apa yang Anda pikirkan?" style="width: 100%; margin-bottom: 8px;"></textarea>
          {{!-- Media Upload --}}
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <label for="media" class="btn btn-light" style="margin: 0; cursor: pointer; font-weight: normal; background-color: var(--bg-color);">
                <i class="fas fa-image"></i> Tambah Media
              </label>
              <input type="file" id="media" name="file" accept="image/*,video/*" style="display: none;">
            </div>
            <button type="submit" class="btn btn-primary">Post</button>
          </div>
        </div>
      </div>
    </form>
  </div>
{{else}}
  <div class="card">
    <h2 style="margin-top: 2px; margin-bottom: 0px;">{{pageTitle}}</h2>
    <p style="margin-bottom: 2px;">{{pesan}}</p>
  </div>
{{/if}}

{{!-- Daftar Postingan --}}
<div class="post-list">
  {{#if posts.length}}
    {{#each posts}}
      <div class="card post-item">
        {{!-- ðŸ‘‡ BLOK KODE BARU DENGAN AVATAR & FLEX HORIZONTAL ðŸ‘‡ --}}
        <div class="post-author-row" style="display: flex; align-items: center; gap: 10px;">
          {{#if this.author}}
            {{!-- Profile Picture with Initials --}}
            <div style="width: 32px; height: 32px; background-color: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; flex-shrink: 0;">
              {{slice this.author.firstName 0 1}}{{slice this.author.lastName 0 1}}
            </div>
            {{!-- Author Name and "Anda" Label --}}
            <div style="display: flex; align-items: center; gap: 8px;">
              {{!-- ðŸ‘‡ PERBAIKI STYLE INI AGAR FONT-WEIGHT TIDAK GANDA ðŸ‘‡ --}}
              <a href="/users/{{this.author.id}}/profile" style="color: inherit; text-decoration: none; font-weight: bold;"> 
                <span class="post-author-name">{{this.author.firstName}} {{this.author.lastName}}</span>
              </a>
              {{#if (eq this.author.id ../user.id)}}
                <span style="background-color: #e9ecef; padding: 2px 6px; border-radius: 4px; font-size: 12px;">Anda</span>
              {{/if}}
            </div>
          {{else}}
            <span class="post-author-name">User Anonim</span>
          {{/if}}
        </div>
        {{!-- ðŸ‘† AKHIR BLOK KODE BARU ðŸ‘† --}}
        <p class="post-meta">{{formatDate this.createdAt}}</p>

        {{!-- Tampilkan teks postingan jika ada --}}
        {{#if this.content}}
          <p class="post-content" style="margin-bottom: 0px;">{{this.content}}</p>
        {{/if}}

        {{!-- TAMPILKAN MEDIA JIKA ADA (MVP v2.3) --}}
        {{#if this.photo}} {{!-- Cek apakah object photo tersedia --}}
          <div class="post-media-container" style="margin-top: 8px;">
            <div class="media-placeholder-icon"><i class="fas fa-camera" style="font-size: 36px; color: #6c757d;"></i></div> {{!-- Ikon Placeholder --}}
          {{!-- Cek tipe file menggunakan mimeType dari backend --}}
          {{!-- Asumsi helper 'contains' sudah tersedia di backend Handlebars Anda --}}
          {{#if (contains this.photo.mimeType 'video')}}
            <video controls>
              <source src="{{this.photo.path}}" type="{{this.photo.mimeType}}">
              Browser Anda tidak mendukung video tag.
            </video>
          {{else}}
            <img src="{{this.photo.path}}"> {{!-- Pastikan ALT DIHAPUS dan tanpa inline style --}}
          {{/if}}
          </div>
        {{/if}}
        {{!-- AKHIR AREA MEDIA --}}

        {{!-- Tombol Follow (MVP v1.4) --}}
        {{#if ../user}} {{!-- Cek apakah user-nya login --}}
          {{#if this.author}}
            {{!-- Tampilkan tombol follow hanya jika post bukan milik user yg login --}}
            {{!-- Helper 'eq' perlu didaftarkan di backend --}}
            {{#unless (eq this.author.id ../user.id)}}
              <form action="/api/v1/users/{{this.author.id}}/follow" method="POST" style="margin-top: 10px; display: inline-block;">
                {{!-- Nanti bisa ganti teks tombol jadi "Unfollow" jika sudah follow --}}
                <button type="submit" class="btn btn-secondary btn-sm">Follow</button>
              </form>
            {{/unless}}
          {{/if}}
        {{/if}}

        {{!-- AREA LIKE (MVP v2.1) --}}
        {{#if ../user}}
        <div class="post-actions" style="margin-top: 16px; display: flex; align-items: center; gap: 10px;">
            {{!-- Logika Kondisional untuk Tombol --}}
            {{#if this.isLikedByCurrentUser}}
              {{!-- JIKA SUDAH LIKE: Tampilkan form UNLIKE --}}
              <form action="/api/v1/posts/{{this.id}}/unlike" method="POST" style="display: inline; margin: 0;">
                <button type="submit" class="btn btn-sm btn-primary" style="padding: 0px; background-color: transparent; color: black; display: flex; align-items: center; gap: 4px;">
                  <i class="fas fa-heart" style="font-size: 20px; color: red; margin-right: 2px;"></i> {{#if this.likesCount}}{{this.likesCount}}{{else}}0{{/if}}
                </button>
              </form>
            {{else}}
              {{!-- JIKA BELUM LIKE: Tampilkan form LIKE --}}
              <form action="/api/v1/posts/{{this.id}}/like" method="POST" style="display: inline; margin: 0;">
                <button type="submit" class="btn btn-sm btn-secondary" style="padding: 0px; background-color: transparent; color: black; display: flex; align-items: center; gap: 4px; font-weight: normal;">
                  <i class="far fa-heart" style="font-size: 20px; color: black; margin-right: 2px;"></i> {{#if this.likesCount}}{{this.likesCount}}{{else}}0{{/if}}
                </button>
              </form>
            {{/if}}
            {{!-- Akhir Logika Kondisional --}}
        </div>
        {{/if}}
        {{!-- AKHIR AREA LIKE --}}

        {{!-- AREA KOMENTAR (MVP v2.2) --}}
        {{!-- Tampilkan border hanya jika user login atau ada komentar --}}
        {{#if ../user}}
          <div class="post-comments" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
        {{else}}
          {{#if this.comments.length}}
            <div class="post-comments" style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
          {{else}}
            <div class="post-comments" style="margin-top: 0px; padding-top: 0;">
          {{/if}}
        {{/if}}
          {{!-- Form Tambah Komentar Utama --}}
          {{#if ../user}} {{!-- Harus ../user karena masih di #each posts --}}
            <form action="/api/v1/posts/{{this.id}}/comments" method="POST" class="comment-form" style="margin-bottom: 15px; display: flex; flex-direction: row; gap: 8px;">
              <input type="hidden" name="postId" value="{{this.id}}">
              <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                <input name="content" class="form-control" rows="1" placeholder="Tulis komentar..." required style="font-size: 0.9em;"></input>
              </div>
              <button type="submit" class="btn btn-secondary btn-sm">Kirim</button>
            </form>
          {{/if}}

          {{!-- Daftar Komentar --}}
          <div class="comment-list">
            {{#if this.comments.length}}
              <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 0.95em;">Komentar:</h4>
              {{!-- Loop Komentar Utama --}}
              {{#each this.comments}}
                <div class="comment-item" style="margin-bottom: 10px; font-size: 0.9em;">
                  <div class="post-author-row" style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 32px; height: 32px; background-color: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; flex-shrink: 0;">
                      {{slice this.author.firstName 0 1}}{{slice this.author.lastName 0 1}}
                    </div>
                    <strong class="comment-author">
                      {{#if this.author}}
                        <a href="/users/{{this.author.id}}/profile" style="color: inherit; text-decoration: none; font-weight: bold;">
                           {{this.author.firstName}} {{this.author.lastName}}
                        </a>
                      {{else}}
                        Anonim
                      {{/if}}
                    </strong>
                    <span style="color: var(--text-secondary-color); text-align: right; flex-grow: 1">{{formatDate this.createdAt}}</span>
                  </div>
                  <p class="comment-content" style="margin: 2px 0 5px 44px;">{{this.content}}</p>

                  {{!-- TOMBOL & FORM BALAS --}}
                  {{#if ../../user}} {{!-- Harus ../../user karena di dalam #each comments --}}
                    <div class="comment-reply-section">
                      <button class="btn-link btn-sm js-reply-button" data-comment-id="{{this.id}}" style="background: none; border: none; color: var(--link-color); cursor: pointer; padding: 0; font-size: 0.9em; margin-left: 44px;">
                        Balas
                      </button>
                      {{!-- Form Balasan (Hidden by default) --}}
                      <form action="/api/v1/comments/{{this.id}}/replies" method="POST" class="reply-form" id="reply-form-{{this.id}}" style="display: none; margin-left: 44px; margin-bottom: 15px; flex-direction: row; gap: 8px;">
                        <input type="hidden" name="postId" value="{{../id}}">
                        <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                          <input name="content" class="form-control" rows="1" placeholder="Tulis balasan..." required style="font-size: 0.95em;"></input>
                        </div>
                        <button type="submit" class="btn btn-secondary btn-sm">Kirim Balasan</button>
                      </form>
                    </div>
                  {{/if}}
                  {{!-- AKHIR TOMBOL & FORM BALAS --}}

                  {{!-- AREA TAMPILKAN BALASAN --}}
                  <div class="comment-replies" style="margin-left: 42px; margin-top: 10px;">
                    {{#if this.replies.length}}
                      {{#each this.replies}}
                        <div class="comment-item reply-item" style="margin-bottom: 8px; font-size: 0.95em;">
                          <div class="post-author-row" style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 32px; height: 32px; background-color: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; flex-shrink: 0;">
                              {{slice this.author.firstName 0 1}}{{slice this.author.lastName 0 1}}
                            </div>
                            <strong class="comment-author">
                              {{#if this.author}}
                                {{!-- ðŸ‘‡ MODIFIKASI DI SINI JUGA: Link ke profil author balasan ðŸ‘‡ --}}
                                <a href="/users/{{this.author.id}}/profile" style="color: inherit; text-decoration: none; font-weight: bold;">
                                   {{this.author.firstName}} {{this.author.lastName}}
                                </a>
                              {{else}}
                                Anonim
                              {{/if}}
                            </strong>
                            <span style="color: var(--text-secondary-color); text-align: right; flex-grow: 1;">{{formatDate this.createdAt}}</span>
                          </div>
                          <p class="comment-content" style="margin: 2px 0 0 44px;">{{this.content}}</p>
                        </div>
                      {{/each}}
                    {{/if}}
                  </div>
                  {{!-- AKHIR AREA BALASAN --}}

                </div> {{!-- Akhir .comment-item --}}
              {{/each}} {{!-- Akhir #each comments --}}
            {{/if}} {{!-- Akhir if comments.length --}}
          </div> {{!-- Akhir .comment-list --}}
        </div> {{!-- Akhir .post-comments --}}
        {{!-- AKHIR AREA KOMENTAR --}}

      </div> {{!-- Akhir .card .post-item --}}
    {{/each}} {{!-- Akhir #each posts --}}
  {{else}}
    <div class="card text-center">
      {{!-- Pesan berbeda jika login vs anonim --}}
      {{#if user}}
        <p>Timeline Anda kosong. Coba follow beberapa user!</p>
      {{else}}
        <p>Belum ada postingan untuk ditampilkan. <a href="/login" class="form-link">Login</a> untuk melihat timeline.</p>
      {{/if}}
    </div>
  {{/if}}
</div>